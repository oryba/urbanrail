import asyncio

import httpx
from bs4 import BeautifulSoup
from slugify import slugify

URL_SCHEDULE = "https://swrailway.gov.ua/timetable/eltrain/?gid=1&rid=471"


def parse_tables(soup, station_names, idx):
    table = soup.find(id=idx).find(class_="gotime")
    trains = []
    for item in table.find_all(class_="on_right_t"):
        ctx = item.find(class_="et").text
        trains.append({
            'schedule': 'daily' if 'щоденно' in ctx.lower() else 'будні',
            'code': ctx.split(',')[0].strip()
        })
    print(trains)

    stations = {}

    for row in table.find('tbody').find_all('tr'):
        if 'on' in row.attrs.get('class', []) or 'onx' in row.attrs.get('class', []):
            cells = row.find_all(class_='q1') or row.find_all(class_='q0')
            if not cells:
                continue
            station = station_names.pop(0)
            deps = []
            for i, cell in enumerate(cells):
                if not i % 2:
                    continue
                if cell.text.strip() == '–':
                    continue
                deps.append(cell.text)
            stations[station] = deps
    return stations


async def get_schedule():
    return [{'station': 'Дарниця', 'slug': 'darnitsia', 'departures_forth': ['06:31', '07:31', '08:01', '08:31', '09:01', '09:31', '10:01', '10:31', '11:31', '12:31', '13:31', '14:31', '15:31', '16:31', '17:01', '17:31', '18:01', '18:31', '19:01', '19:31', '20:31', '21:31'], 'departures_back': ['06:37', '07:37', '08:07', '08:37', '09:07', '09:37', '10:07', '10:37', '11:37', '12:37', '13:37', '14:37', '15:37', '16:37', '17:07', '17:37', '18:07', '18:37', '19:07', '19:37', '20:37', '21:37']}, {'station': 'Київська Русанівка', 'slug': 'kiyivska-rusanivka', 'departures_forth': ['05:35', '06:35', '07:05', '07:35', '08:05', '08:35', '09:05', '09:35', '10:05', '10:35', '11:35', '12:35', '13:35', '14:35', '15:35', '16:35', '17:05', '17:35', '18:05', '18:35', '19:05', '19:35', '20:35', '21:36'], 'departures_back': ['06:24', '07:26', '07:54', '08:24', '08:54', '09:24', '09:54', '10:24', '11:24', '12:26', '13:24', '14:24', '15:24', '16:24', '16:54', '17:24', '17:54', '18:24', '18:54', '19:24', '20:24', '21:24', '22:24']}, {'station': 'Лівобережна', 'slug': 'livoberezhna', 'departures_forth': ['05:38', '06:38', '07:08', '07:38', '08:08', '08:38', '09:08', '09:38', '10:08', '10:38', '11:38', '12:38', '13:38', '14:38', '15:38', '16:38', '17:08', '17:38', '18:08', '18:38', '19:08', '19:38', '20:38', '21:39'], 'departures_back': ['06:22', '07:22', '07:52', '08:22', '08:52', '09:22', '09:52', '10:22', '11:22', '12:22', '13:22', '14:22', '15:22', '16:22', '16:52', '17:22', '17:52', '18:22', '18:52', '19:22', '20:22', '21:22', '22:22']}, {'station': 'Київ-Дніпров.', 'slug': 'kiyiv-dniprov', 'departures_forth': ['05:41', '06:41', '07:11', '07:41', '08:11', '08:41', '09:11', '09:41', '10:11', '10:41', '11:41', '12:41', '13:41', '14:41', '15:41', '16:41', '17:11', '17:41', '18:11', '18:41', '19:11', '19:41', '20:41', '21:42'], 'departures_back': ['06:19', '07:19', '07:49', '08:19', '08:49', '09:19', '09:49', '10:19', '11:19', '12:19', '13:19', '14:19', '15:19', '16:19', '16:49', '17:19', '17:49', '18:19', '18:49', '19:19', '20:19', '21:19', '22:19']}, {'station': 'Троєщина', 'slug': 'troieshchina', 'departures_forth': ['05:44', '06:44', '07:14', '07:44', '08:14', '08:44', '09:14', '09:44', '10:14', '10:44', '11:44', '12:44', '13:44', '14:44', '15:44', '16:44', '17:14', '17:44', '18:14', '18:44', '19:14', '19:44', '20:44', '21:45'], 'departures_back': ['06:16', '07:16', '07:46', '08:16', '08:46', '09:16', '09:46', '10:16', '11:16', '12:16', '13:16', '14:16', '15:16', '16:16', '16:46', '17:16', '17:46', '18:16', '18:46', '19:16', '20:16', '21:16', '22:16']}, {'station': 'Троєщина-2', 'slug': 'troieshchina-2', 'departures_forth': ['05:46', '06:46', '07:16', '07:46', '08:16', '08:46', '09:16', '09:46', '10:16', '10:46', '11:46', '12:46', '13:46', '14:46', '15:46', '16:46', '17:16', '17:46', '18:16', '18:46', '19:16', '19:46', '20:46', '21:47'], 'departures_back': ['06:14', '07:14', '07:44', '08:14', '08:44', '09:14', '09:44', '10:14', '11:14', '12:14', '13:14', '14:14', '15:14', '16:14', '16:44', '17:14', '17:44', '18:14', '18:44', '19:14', '20:14', '21:14', '22:14']}, {'station': 'Почайна', 'slug': 'pochaina', 'departures_forth': ['05:57', '06:57', '07:27', '07:57', '08:27', '08:57', '09:27', '09:57', '10:27', '10:57', '11:57', '12:57', '13:57', '14:57', '15:57', '16:57', '17:27', '17:57', '18:27', '18:57', '19:27', '19:57', '20:57', '21:57'], 'departures_back': ['06:03', '07:03', '07:33', '08:03', '08:33', '09:03', '09:33', '10:03', '11:03', '12:03', '13:03', '14:03', '15:03', '16:03', '16:33', '17:03', '17:33', '18:03', '18:33', '19:03', '20:03', '21:03', '22:03']}, {'station': 'Зеніт', 'slug': 'zenit', 'departures_forth': ['06:00', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '21:00', '22:00'], 'departures_back': ['06:00', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '20:00', '21:00', '22:00']}, {'station': 'Вишгородська', 'slug': 'vishgorodska', 'departures_forth': ['06:04', '07:04', '07:34', '08:04', '08:34', '09:04', '09:34', '10:04', '10:34', '11:04', '12:04', '13:04', '14:04', '15:04', '16:04', '17:04', '17:34', '18:04', '18:34', '19:04', '19:34', '20:04', '21:04', '22:04'], 'departures_back': ['05:56', '06:56', '07:26', '07:56', '08:26', '08:56', '09:26', '09:56', '10:56', '11:56', '12:56', '13:56', '14:56', '15:56', '16:26', '16:56', '17:26', '17:56', '18:26', '18:56', '19:56', '20:56', '21:56']}, {'station': 'Сирець', 'slug': 'sirets', 'departures_forth': ['06:09', '07:09', '07:39', '08:09', '08:39', '09:09', '09:39', '10:09', '10:39', '11:09', '12:09', '13:09', '14:09', '15:09', '16:09', '17:09', '17:39', '18:09', '18:39', '19:09', '19:39', '20:09', '21:09', '22:09'], 'departures_back': ['05:51', '06:51', '07:21', '07:51', '08:21', '08:51', '09:21', '09:51', '10:51', '11:51', '12:51', '13:51', '14:51', '15:51', '16:21', '16:51', '17:21', '17:51', '18:21', '18:51', '19:51', '20:51', '21:51']}, {'station': 'Рубежівська', 'slug': 'rubezhivska', 'departures_forth': ['06:13', '07:13', '07:43', '08:13', '08:43', '09:13', '09:43', '10:13', '10:43', '11:13', '12:13', '13:13', '14:13', '15:13', '16:13', '17:13', '17:43', '18:13', '18:43', '19:13', '19:43', '20:13', '21:13', '22:13'], 'departures_back': ['05:47', '06:47', '07:17', '07:47', '08:17', '08:47', '09:17', '09:47', '10:47', '11:47', '12:47', '13:47', '14:47', '15:47', '16:17', '16:47', '17:17', '17:47', '18:17', '18:47', '19:47', '20:47', '21:47']}, {'station': 'Святошин', 'slug': 'sviatoshin', 'departures_forth': ['05:30', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:30', '11:30', '12:30', '13:30', '14:30', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:30', '20:30', '21:30'], 'departures_back': ['21:39']}, {'station': 'Борщагівка', 'slug': 'borshchagivka', 'departures_forth': ['05:36', '06:36', '07:06', '07:36', '08:06', '08:36', '09:06', '09:36', '10:36', '11:36', '12:36', '13:36', '14:36', '15:36', '16:06', '16:36', '17:06', '17:36', '18:06', '18:36', '19:36', '20:36', '21:36'], 'departures_back': ['06:23', '07:23', '07:53', '08:23', '08:53', '09:23', '09:53', '10:23', '10:53', '11:23', '12:23', '13:23', '14:23', '15:23', '16:23', '17:23', '17:53', '18:23', '18:53', '19:23', '19:53', '20:23', '21:23', '22:27']}, {'station': 'Борщагівка техн.', 'slug': 'borshchagivka-tekhn', 'departures_forth': [], 'departures_back': []}, {'station': 'Київ-Волинський', 'slug': 'kiyiv-volinskii', 'departures_forth': ['05:44', '06:44', '07:14', '07:44', '08:14', '08:44', '09:14', '09:44', '10:44', '11:44', '12:44', '13:44', '14:44', '15:44', '16:14', '16:44', '17:14', '17:44', '18:14', '18:44', '19:44', '20:44', '21:44'], 'departures_back': ['06:16', '07:16', '07:46', '08:16', '08:46', '09:16', '09:46', '10:16', '10:46', '11:16', '12:16', '13:16', '14:16', '15:16', '16:16', '17:16', '17:46', '18:16', '18:46', '19:16', '19:46', '20:16', '21:16']}, {'station': 'Караваєві Дачі', 'slug': 'karavaievi-dachi', 'departures_forth': ['05:49', '06:49', '07:19', '07:49', '08:19', '08:49', '09:19', '09:49', '10:49', '11:49', '12:49', '13:49', '14:49', '15:49', '16:19', '16:49', '17:19', '17:49', '18:19', '18:49', '19:49', '20:49', '21:49'], 'departures_back': ['06:10', '07:10', '07:40', '08:10', '08:40', '09:10', '09:40', '10:10', '10:40', '11:10', '12:10', '13:10', '14:10', '15:10', '16:10', '17:10', '17:40', '18:10', '18:40', '19:10', '19:40', '20:10', '21:10', '22:14']}, {'station': 'Київ-Пас. (Північна)', 'slug': 'kiyiv-pas-pivnichna', 'departures_forth': ['05:56', '06:56', '07:26', '07:56', '08:26', '08:56', '09:26', '09:56', '10:56', '11:56', '12:56', '13:56', '14:56', '15:56', '16:26', '16:56', '17:26', '17:56', '18:26', '18:56', '19:56', '20:56', '21:56'], 'departures_back': ['06:04', '07:04', '07:34', '08:04', '08:34', '09:04', '09:34', '10:04', '10:34', '11:04', '12:04', '13:04', '14:04', '15:04', '16:04', '17:04', '17:34', '18:04', '18:34', '19:04', '19:34', '20:04', '21:04', '22:04']}, {'station': 'Протасів Яр', 'slug': 'protasiv-iar', 'departures_forth': ['06:02', '07:02', '07:32', '08:02', '08:32', '09:02', '09:32', '10:02', '11:02', '12:02', '13:02', '14:02', '15:02', '16:02', '16:32', '17:02', '17:32', '18:02', '18:32', '19:02', '20:02', '21:02', '22:02'], 'departures_back': ['05:58', '06:58', '07:28', '07:58', '08:28', '08:58', '09:28', '09:58', '10:28', '10:58', '11:58', '12:58', '13:58', '14:58', '15:58', '16:58', '17:28', '17:58', '18:28', '18:58', '19:28', '19:58', '20:58', '21:58']}, {'station': 'Київ-Деміївський', 'slug': 'kiyiv-demiyivskii', 'departures_forth': ['06:07', '07:07', '07:37', '08:07', '08:37', '09:07', '09:37', '10:07', '11:07', '12:07', '13:07', '14:07', '15:07', '16:07', '16:37', '17:07', '17:37', '18:07', '18:37', '19:07', '20:07', '21:07', '22:07'], 'departures_back': ['05:53', '06:53', '07:23', '07:53', '08:23', '08:53', '09:23', '09:53', '10:23', '10:53', '11:53', '12:53', '13:53', '14:53', '15:53', '16:53', '17:23', '17:53', '18:23', '18:53', '19:23', '19:53', '20:53', '21:53']}, {'station': 'Видубичі', 'slug': 'vidubichi', 'departures_forth': ['06:11', '07:11', '07:41', '08:11', '08:41', '09:11', '09:41', '10:11', '11:11', '12:11', '13:11', '14:11', '15:11', '16:11', '16:41', '17:11', '17:41', '18:11', '18:41', '19:11', '20:11', '21:11', '22:11'], 'departures_back': ['05:50', '06:50', '07:20', '07:50', '08:20', '08:50', '09:20', '09:50', '10:20', '10:50', '11:50', '12:50', '13:50', '14:50', '15:50', '16:50', '17:20', '17:50', '18:20', '18:50', '19:20', '19:50', '20:50', '21:50']}, {'station': 'Лівий Берег', 'slug': 'livii-bereg', 'departures_forth': ['06:18', '07:18', '07:48', '08:18', '08:48', '09:18', '09:48', '10:18', '11:18', '12:18', '13:18', '14:18', '15:18', '16:18', '16:48', '17:18', '17:48', '18:18', '18:48', '19:18', '20:18', '21:18', '22:18'], 'departures_back': ['05:43', '07:13']}]

    async with httpx.AsyncClient() as client:
        resp = await client.get(URL_SCHEDULE)
    soup = BeautifulSoup(resp.content, features="html5lib")
    schedule = []

    station_names_forth = [
        el.text.strip().strip('\n').replace('з.п. ', '')
        for el in soup.find(id="tabs-trains1").find(class_="left").find_all(class_="et")
    ]

    station_names_back = [
        el.text.strip().strip('\n').replace('з.п. ', '')
        for el in soup.find(id="tabs-trains2").find(class_="left").find_all(class_="et")
    ]

    stations_forth = parse_tables(soup, station_names_forth[:], "tabs-trains1")
    stations_back = parse_tables(soup, station_names_back[:], "tabs-trains2")
    for station in stations_forth:
        schedule.append({
            'station': station,
            'slug': slugify(station),
            'departures_forth': stations_forth[station],
            'departures_back': stations_back[station]
        })
    return schedule


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    loop.run_until_complete(get_schedule())
